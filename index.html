<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Interactive Solar Utilization Heatmap</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body { margin:0; overflow:hidden; }
    #controls {
      position:absolute; top:10px; left:10px;
      background:rgba(255,255,255,0.9);
      padding:10px; border-radius:4px;
      font-family:sans-serif; z-index:1000;
    }
    #controls label { margin-right:10px; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
  </style>

  <!-- deck.gl + MapLibre GL -->
  <script src="https://unpkg.com/deck.gl@8.8.19/dist.min.js"></script>
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <link   href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet"/>

  <!-- PapaParse for CSV parsing -->
  <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
</head>
<body>
  <div id="controls">
    <label>Solar:
      <select id="solarSelect"></select>
    </label>
    <label>Battery:
      <select id="batterySelect"></select>
    </label>
  </div>
  <div id="map"></div>

  <script>
  // — Populate selectors —
  const solarSel   = document.getElementById('solarSelect');
  const batterySel = document.getElementById('batterySelect');
  for(let i=1;i<=10;i++) solarSel.add(new Option(i+' GW', i));
  for(let j=1;j<=15;j++) batterySel.add(new Option(j+' GWh', j));
  solarSel.value = 1;
  batterySel.value = 1;

  // — Data holders —
  let pointsData = null;

  // — Initialize deck.gl with MapLibre style —
  const deckgl = new deck.DeckGL({
    container: 'map',
    mapStyle: 'https://demotiles.maplibre.org/style.json',
    mapboxApiAccessToken: '',            // not needed for MapLibre
    initialViewState: {
      longitude: 0,
      latitude: 20,
      zoom: 1.2,
      pitch: 30,
      bearing: 0
    },
    controller: true,
    layers: []
  });

  // — Load your two CSVs (must be in same folder) —
  Promise.all([
    fetch('locations_100locs.csv').then(r=>r.text()),
    fetch('utilization_100locs.csv').then(r=>r.text())
  ]).then(([locTxt, utilTxt])=>{
    const locs = Papa.parse(locTxt, { header:true, dynamicTyping:true }).data;
    const utils= Papa.parse(utilTxt,{ header:true, dynamicTyping:true }).data;

    // join on first column (e.g. "loc")
    const key = Object.keys(locs[0])[0];
    const utilMap = {};
    utils.forEach(u => { if(u[key]!=null) utilMap[u[key]] = u; });

    // build pointsData array of { position: [lon,lat], ...utilProperties }
    pointsData = locs.map(r => {
      const u = utilMap[r[key]] || {};
      return Object.assign(
        { position: [r.lon, r.lat] },
        u
      );
    });

    // first render
    renderHeatmap();
  }).catch(err=>{
    console.error("Failed to load CSVs—make sure both are in the same HTTP‑served folder:", err);
    alert("CSV load error; check console.");
  });

  // — Render or update the heatmap layer —
  function renderHeatmap(){
    if(!pointsData) return;
    const s = solarSel.value, b = batterySel.value;
    const weightKey = `${s}GW_${b}GWh`;

    const heat = new deck.HeatmapLayer({
      id: 'heat',
      data: pointsData,
      getPosition: d => d.position,
      getWeight:   d => d[weightKey] || 0,
      radiusPixels: 60,
      intensity: 1,
      threshold: 0.03
    });

    deckgl.setProps({ layers: [heat] });
  }

  // — Update on user selection —
  solarSel  .addEventListener('change', renderHeatmap);
  batterySel.addEventListener('change', renderHeatmap);
  </script>
</body>
</html>
